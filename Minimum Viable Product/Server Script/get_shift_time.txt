ðð®ð«ð©ð¨ð¬ðž : ð“ð¡ð¢ð¬ ð¬ðžð«ð¯ðžð« ð¬ðœð«ð¢ð©ð­ ð¢ð¬ ð°ð«ð¢ð­ð­ðžð§ ðŸð¨ð« ð¬ðžð§ðð¢ð§ð  ðšð§ ðšð¥ðžð«ð­ ð­ð¨ ð­ð¡ðž ð„ð¦ð©ð¥ð¨ð²ðžðž ðšð¬ð¤ð¢ð§ð  ð¡ðž/ð¬ð¡ðž ð­ð¨ ð¬ð¡ðšð«ðž ð­ð¡ðž ðœð®ð«ð«ðžð§ð­ ð¥ð¨ðœðšð­ð¢ð¨ð§ ð¢ð§ ð¨ð«ððžð« ð­ð¨ ð¦ðšð«ð¤ ð¡ð¢ð¬/ð¡ðžð« ðšð­ð­ðžð§ððšð§ðœðž. ð“ð¡ð¢ð¬ ðšð¥ðžð«ð­ ð°ð¢ð¥ð¥ ð­ð«ð¢ð ð ðžð« ð›ðžðŸð¨ð«ðž ðšð§ð ðšðŸð­ðžð« ð¬ð¡ð¢ðŸð­ ð¬ð­ðšð«ð­ ðšð§ð ð¬ð¡ð¢ðŸð­ ðžð§ð ð­ð¢ð¦ðž.( ðð«ðžð¬ðžð§ð­ð¥ð² ð­ð¡ðž ð¯ðšð¥ð®ðžð¬ ðšð«ðž ð¡ðšð«ððœð¨ððžð).

ð—˜ð˜…ð—®ð—ºð—½ð—¹ð—²: ð‡ð¢ ð’ð®ð¯ð«ð¨ ðƒðžð›ððšð¬. ðð¥ðžðšð¬ðž ð¬ð¡ðšð«ðž ð²ð¨ð®ð« ðœð®ð«ð«ðžð§ð­ ð¥ð¨ðœðšð­ð¢ð¨ð§ ðŸð¨ð« ð¦ðšð«ð¤ð¢ð§ð  ð²ð¨ð®ð« ðšð­ð­ðžð§ððšð§ðœðž.

i1=10
i2=10
i3=30
i4=5
i5=30

emp=frappe.db.sql(""" SELECT a.employee,a.employee_name,a.country_code,a.cell_number,
                        b.start_time,b.end_time,a.attendance_reminder_type,a.preferred_language
                    FROM 
                    `tabEmployee` as a
                    INNER JOIN 
                    `tabShift Type` as b
                    ON a.default_shift=b.name
                    WHERE a.status="Active";""",as_dict=True)
                    
for k in emp:
    
    recipient=k.country_code+k.cell_number
    
    shift_start_time=" "
    shift_end_time=" "
    shift_start=k.start_time
    shift_end=k.end_time
    
    if (shift_end>shift_start):
        frappe.errprint("ok")
        time_difference=shift_start.seconds
        hours = time_difference // 3600 
        minutes = (time_difference // 60) % 60
        seconds = time_difference % 60
        
        time_difference_one=shift_end.seconds
        hours_one = time_difference_one // 3600  # 3600 seconds in an hour
        minutes_one = (time_difference_one // 60) % 60  # 60 seconds in a minute
        seconds_one = time_difference_one % 60
            
        # frappe.errprint(frappe.utils.add_to_date(frappe.utils.getdate(),hours=hours,minutes=minutes,seconds=seconds))
        shift_start_time=frappe.utils.add_to_date(frappe.utils.getdate(),hours=hours,minutes=minutes,seconds=seconds)
        shift_end_time=frappe.utils.add_to_date(frappe.utils.getdate(),hours=hours_one,minutes=minutes_one,seconds=seconds_one)
        # time_diff=frappe.utils.time_diff(frappe.utils.now(),shift_start_time)
        # frappe.errprint(time_diff.total_seconds()/60)
        
    else:
        frappe.errprint("reverse")
        
        
        
        
        time_difference=shift_start.seconds
        hours = time_difference // 3600  # 3600 seconds in an hour
        minutes = (time_difference // 60) % 60  # 60 seconds in a minute
        seconds = time_difference % 60
        
        # time_diff=frappe.utils.time_diff(frappe.utils.now(),"00:00:00")
        
        time_difference_one=shift_end.seconds
        hours_one = time_difference_one // 3600  # 3600 seconds in an hour
        minutes_one = (time_difference_one // 60) % 60  # 60 seconds in a minute
        seconds_one = time_difference_one % 60
        
        time_diff=frappe.utils.time_diff(frappe.utils.now(),"00:00:00")
        
        # frappe.errprint(time_diff.total_seconds()/3600)
        
        if(time_diff.total_seconds()/3600 >= hours or time_diff.total_seconds()/3600 >= (shift_end.seconds)//3600):
                
            shift_start_time=frappe.utils.add_to_date(frappe.utils.getdate(),hours=hours,minutes=minutes,seconds=seconds)
            shift_end_time=frappe.utils.add_to_date(frappe.utils.getdate(),days=1,hours=hours_one,minutes=minutes_one,seconds=seconds_one)
        else:
            shift_start_time=frappe.utils.add_to_date(frappe.utils.getdate(),days=-1,hours=hours,minutes=minutes,seconds=seconds)
            shift_end_time=frappe.utils.add_to_date(frappe.utils.getdate(),hours=hours_one,minutes=minutes_one,seconds=seconds_one)
            
    # frappe.errprint(shift_start_time)  
    # frappe.errprint(shift_end_time)
    t1=frappe.utils.add_to_date(shift_start_time,minutes=-i1)
    frappe.errprint(t1)
    t11=frappe.utils.add_to_date(t1,minutes=4)
    
    t2=frappe.utils.add_to_date(shift_start_time,minutes=i2)
    frappe.errprint(t2)
    t21=frappe.utils.add_to_date(t2,minutes=4)
    
    t3=frappe.utils.add_to_date(shift_start_time,minutes=i3)
    frappe.errprint(t3)
    t31=frappe.utils.add_to_date(t3,minutes=4)
    
    t4=frappe.utils.add_to_date(shift_end_time,minutes=-i4)
    frappe.errprint(t4)
    t41=frappe.utils.add_to_date(t4,minutes=4)
    
    t5=frappe.utils.add_to_date(shift_end_time,minutes=i5)
    frappe.errprint(t5)
    t51=frappe.utils.add_to_date(t5,minutes=4)
    
    
    pre_count=frappe.db.sql("""SELECT count(employee) as count,employee FROM `tabEmployee Checkin` WHERE Date(time)=CURDATE() AND employee=%s;""",k.employee,as_dict=True)
    # frappe.errprint(pre_count[0].count)
    
    if(pre_count[0].count==0):
    
        
        # frappe.errprint(k.employee)
        leave_count=frappe.db.sql("""SELECT 
                                    count(employee) as countl
                                    FROM
                                    `tabLeave Application`
                                    WHERE employee=%s AND status="Approved" AND CURDATE() BETWEEN from_date AND to_date;""",(k.employee),as_dict=True)
        
        if(leave_count[0].countl==0):
            
            holiday_count=frappe.db.sql("""SELECT count(c.holiday_date) as counth
                                            FROM 
                                            `tabEmployee` as a
                                            INNER JOIN 
                                            `tabHoliday List` as b
                                            ON a.holiday_list=b.name
                                            INNER JOIN 
                                            `tabHoliday` as c
                                            ON b.name=c.parent
                                            WHERE a.employee=%s
                                            AND c.holiday_date=CURDATE();""",(k.employee),as_dict=True)
                                            
            if(holiday_count[0].counth==0):
                
                # frappe.errprint(k.employee)
                # frappe.errprint(k.cell_number)
                # if(k.attendance_reminder_type=="1"):
                #     msg=f"Hi! {k.employee_name}.Please mark your attendance.Enter 'I' for Checkin or 'O' for Checkout."
                    
                # elif(k.attendance_reminder_type=="2"):
                #     msg=f"Hi! {k.employee_name}.Please share current location to mark your attendance."
                    
                # elif(k.attendance_reminder_type=="3"):
                #     msg=f"Hi! {k.employee_name}.Please share current location to mark your attendance."
                    
                ct=frappe.utils.get_datetime(frappe.utils.now())
                if(t1<ct<=t11):
                    frappe.call('gewin_payroll.wa.send_attendance_notification',recipient=recipient,employee_name=k.employee_name,attendance_message_type=k.attendance_reminder_type,language=k.preferred_language)
                    
                elif(t2<ct<=t21): 
                    frappe.call('gewin_payroll.wa.send_attendance_notification',recipient=recipient,employee_name=k.employee_name,attendance_message_type=k.attendance_reminder_type,language=k.preferred_language)
                    
                elif(t3<ct<=t31):
                    frappe.call('gewin_payroll.wa.send_attendance_notification',recipient=recipient,employee_name=k.employee_name,attendance_message_type=k.attendance_reminder_type,language=k.preferred_language)    
    
    
    else:
        frappe.errprint(k.employee)
        
        log_type=frappe.db.sql("""SELECT log_type 
        FROM
        `tabEmployee Checkin`
        WHERE employee=%s
        ORDER BY time DESC limit 1;""",(k.employee),as_dict=True)
         
        frappe.errprint(log_type[0].log_type) 
        
        if(log_type[0].log_type!="OUT"):
        
            # if(k.attendance_reminder_type=="1"):
            #         msg=f"Hi! {k.employee_name}.Please mark your attendance.Enter 'I' for Checkin or 'O' for Checkout."
                    
            # elif(k.attendance_reminder_type=="2"):
            #     msg=f"Hi! {k.employee_name}.Please share current location to mark your attendance."
                
            # elif(k.attendance_reminder_type=="3"):
            #     msg=f"Hi! {k.employee_name}.Please share current location to mark your attendance."
            
            ct=frappe.utils.get_datetime(frappe.utils.now())
            
            if(t4 < ct <= t41):
                frappe.call('gewin_payroll.wa.send_attendance_notification',recipient=recipient,employee_name=k.employee_name,attendance_message_type=k.attendance_reminder_type,language=k.preferred_language)
                
            elif(t5 < ct <= t51): 
                frappe.call('gewin_payroll.wa.send_attendance_notification',recipient=recipient,employee_name=k.employee_name,attendance_message_type=k.attendance_reminder_type,language=k.preferred_language)